graph TB
    %% Input Sources
    subgraph "Data Sources"
        MDM1[Commercial MDM<br/>• Corporate entities<br/>• Customer relationships<br/>• Vendor relationships]
        MDM2[Capital Markets MDM<br/>• Trading accounts<br/>• Investment portfolios<br/>• Broker relationships<br/>• Fund structures]
        MDM3[CNB MDM<br/>• Filing relationships<br/>• Compliance data<br/>• Disclosure records]
        DocRepo[Document Repository<br/>• Trading authorizations<br/>• Investment management agreements<br/>• Custody agreements<br/>• Powers of attorney]
    end

    %% Phase 1: Entity Facts Only
    subgraph "Phase 1: Entity Facts Extraction"
        FactExtract[Entity Fact Extractors<br/>• Entity identification<br/>• Document references<br/>• System identifiers<br/>• NO relationship extraction]
        
        subgraph "Entity Facts Output"
            EntityFacts[Entity Facts Database<br/>• Names and identifiers<br/>• Document references<br/>• System mappings<br/>• NO cross-system relationships]
        end
    end

    %% Phase 2: Document Analysis for Assertions
    subgraph "Phase 2: Proof Document Analysis"
        ProofAnalyzer[Proof Document Analyzer<br/>• Extract relationship assertions<br/>• Identify entities mentioned<br/>• Parse authority scopes<br/>• Generate confidence scores]
        
        subgraph "Assertion Output"
            Assertions[Relationship Assertions<br/>• Raw text extractions<br/>• Entity name mentions<br/>• Trading authority indicators<br/>• Investment management scopes<br/>• NOT actual relationships]
        end
    end

    %% Phase 3: Human-Driven Relationship Creation
    subgraph "Phase 3: Human-Guided Relationship Establishment"
        UI[Assertion-Driven UI<br/>• Present assertions to operators<br/>• Guide entity resolution<br/>• Facilitate relationship creation<br/>• Validate cross-MDM mappings]
        
        Operator[Operations Team<br/>• Review assertions<br/>• Resolve entity references<br/>• Define relationship parameters<br/>• Create explicit relationships]
        
        subgraph "UI Components"
            AssertionReview[Assertion Review Interface<br/>• Display extracted assertions<br/>• Show confidence levels<br/>• Highlight entity mentions]
            
            EntityResolver[Cross-MDM Entity Resolver<br/>• Search across all MDMs<br/>• Present entity candidates<br/>• Show system mappings<br/>• Verify identity matches]
            
            RelBuilder[Relationship Builder<br/>• Select relationship types<br/>• Define authority scopes<br/>• Set temporal parameters<br/>• Specify trading limits]
            
            Validator[Relationship Validator<br/>• Check logical consistency<br/>• Verify entity mappings<br/>• Validate authority claims<br/>• Confirm proof backing]
        end
    end

    %% Phase 4: Cross-System Relationship Storage
    subgraph "Phase 4: Explicit Relationship Management"
        RelManager[Cross-MDM Relationship Manager<br/>• Store verified relationships<br/>• Maintain proof links<br/>• Track operator decisions<br/>• Audit relationship creation]
        
        subgraph "Cross-MDM Relationship Types"
            TradingAuth[has_trading_authority_for<br/>• Individual → Corporate accounts<br/>• PM → Client portfolios<br/>• Broker → Trading accounts]
            
            InvestMgmt[manages_investments_for<br/>• Asset manager → Client<br/>• Fund manager → Fund<br/>• Advisor → Portfolio]
            
            Custodial[is_custodian_for<br/>• Custodian bank → Assets<br/>• Prime broker → Securities<br/>• Clearing firm → Positions]
            
            Operational[operates_on_behalf_of<br/>• Trading desk → Client<br/>• Portfolio manager → Fund<br/>• Execution agent → Principal]
        end
        
        subgraph "Relationship Storage"
            RelGraph[Cross-System Relationship Graph<br/>• Canonical entity nodes<br/>• Explicit relationship edges<br/>• Proof document links<br/>• Operator audit trail]
            
            ProofRegistry[Proof Registry<br/>• Document metadata<br/>• Assertion extractions<br/>• Verification status<br/>• Usage tracking]
        end
    end

    %% Phase 5: Query and Validation
    subgraph "Phase 5: Relationship Querying"
        QueryEngine[Query Engine<br/>• Cross-MDM relationship queries<br/>• Authority chain analysis<br/>• Proof validation<br/>• Audit trail reporting]
        
        subgraph "Query Capabilities"
            TradingQueries["Trading Authority Queries<br/>• Who can trade for Entity X?<br/>• What accounts can Person Y access?<br/>• What trading limits apply?"]
            
            InvestmentQueries["Investment Management Queries<br/>• Who manages Portfolio Z?<br/>• What funds does Manager A oversee?<br/>• What investment authority exists?"]
            
            ProofQueries["Proof Queries<br/>• What proves this authority?<br/>• When was authority granted?<br/>• What documents support this?"]
        end
    end

    %% Operational Support
    subgraph "Operational Support Systems"
        Monitoring[Relationship Monitoring<br/>• Trading authority expiration<br/>• Investment mandate changes<br/>• Custody arrangement updates<br/>• Regulatory notifications]
        
        Compliance[Compliance Management<br/>• Trading authority reporting<br/>• Investment advisor registration<br/>• Custody rule compliance<br/>• Best execution monitoring]
        
        RiskMgmt[Risk Management<br/>• Trading limit enforcement<br/>• Position monitoring<br/>• Counterparty exposure<br/>• Authority scope validation]
    end

    %% Data Flows
    MDM1 --> FactExtract
    MDM2 --> FactExtract
    MDM3 --> FactExtract
    DocRepo --> ProofAnalyzer
    
    FactExtract --> EntityFacts
    ProofAnalyzer --> Assertions
    
    EntityFacts --> UI
    Assertions --> UI
    UI --> Operator
    
    Operator --> AssertionReview
    Operator --> EntityResolver
    Operator --> RelBuilder
    Operator --> Validator
    
    AssertionReview --> RelManager
    EntityResolver --> RelManager
    RelBuilder --> RelManager
    Validator --> RelManager
    
    RelManager --> TradingAuth
    RelManager --> InvestMgmt
    RelManager --> Custodial
    RelManager --> Operational
    
    TradingAuth --> RelGraph
    InvestMgmt --> RelGraph
    Custodial --> RelGraph
    Operational --> RelGraph
    RelManager --> ProofRegistry
    
    RelGraph --> QueryEngine
    ProofRegistry --> QueryEngine
    
    QueryEngine --> TradingQueries
    QueryEngine --> InvestmentQueries
    QueryEngine --> ProofQueries
    
    RelManager --> Monitoring
    RelManager --> Compliance
    RelManager --> RiskMgmt

    %% Critical Decision Points
    Assertions -.->|NO AUTO-CREATION| RelManager
    EntityFacts -.->|NO RELATIONSHIPS| RelGraph
    UI -.->|HUMAN REQUIRED| RelManager

    %% Styling
    classDef inputSource fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef processing fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef human fill:#fff3e0,stroke:#e65100,stroke-width:3px
    classDef storage fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef relationships fill:#f3e5ab,stroke:#f57f17,stroke-width:2px
    classDef output fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    classDef support fill:#f1f8e9,stroke:#33691e,stroke-width:2px
    
    class MDM1,MDM2,MDM3,DocRepo inputSource
    class FactExtract,ProofAnalyzer,RelManager,QueryEngine processing
    class UI,Operator,AssertionReview,EntityResolver,RelBuilder,Validator human
    class EntityFacts,Assertions,RelGraph,ProofRegistry storage
    class TradingAuth,InvestMgmt,Custodial,Operational relationships
    class TradingQueries,InvestmentQueries,ProofQueries output
    class Monitoring,Compliance,RiskMgmt support